<h1>Billing Page</h1>

<%= form_with url: purchases_path, method: :post do |f| %>

  <label>Email</label><br>
  <%= f.email_field :email, required: true, style: "width: 20%;", placeholder: "Enter email", id: "customer_email" %>
  <button type="button" onclick="loadCustomerPurchases()">Purchase History</button>

  <div id="purchase_history" style="margin-top: 10px;"></div>
  <div id="previous_items" style="margin-top: 10px;"></div>

  <h3>Products</h3>

  <div id="items">
    <div class="item">
      <select id = "product-option" name="items[][product_id]" onchange="updateMaxQty(this); calculateTotal()" required>
        <option value="">Select Product</option>
        <% @products.each do |p| %>
          <% next if p.stock <= 0 %>
          <option value="<%= p.id %>" data-price="<%= p.price %>" data-tax="<%= p.tax_percentage %>" data-stock="<%= p.stock %>">
            <%= p.name %> (₹<%= p.price %>, Stock: <%= p.stock %>)
          </option>
        <% end %>
      </select>

      <input id= "number-quntity" type="number" name="items[][quantity]" min="1" placeholder="Quantity" oninput="calculateTotal()" required>
      <button type="button" onclick="removeItem(this)">❌</button>
    </div>
  </div>

  <button type="button" onclick="addItem()">Add Product</button>

  <hr>

  <h3>Cash Paid by Customer</h3>

  <% @denominations.each do |d| %>
    <div>
      ₹<%= d.value %>
      <input type="number" min="0" value="0" name="denominations[][count]" data-value="<%= d.value %>" oninput="calculatePaidAmount()" style="width: 10%;">
      <input type="hidden" name="denominations[][id]" value="<%= d.id %>">
    </div>
  <% end %>

  <p>
    <strong>Paid Amount: ₹</strong>
    <input type="number" id="paid_amount" name="paid_amount" value="0" step="0.01" oninput="calculateBalance(); syncDenominations()" style="width: 20%;">
    <div id="paid_error" style="color: red; font-size: 0.9em; display: none;"></div>
  </p>
  <p><strong>Total Bill: ₹<span id="total">0.00</span></strong></p>

  <br>
  <%= f.submit "Generate Bill" %>
<% end %>


<script>
function calculateTotal() {
  let total = 0;

  document.querySelectorAll(".item").forEach(item => {
    const select = item.querySelector("select");
    const qty = item.querySelector("input").value;

    if (!select.value || !qty) return;

    const price = parseFloat(select.selectedOptions[0].dataset.price);
    const tax = parseFloat(select.selectedOptions[0].dataset.tax);
    const base = price * qty;

    total += base + (base * tax / 100);
  });

  document.getElementById("total").innerText = total.toFixed(2);
}

function syncDenominations() {
  let totalPaid = parseFloat(document.getElementById("paid_amount").value) || 0;
  if (totalPaid <= 0) return;

  const denoms = Array.from(document.querySelectorAll("[data-value]"))
                       .sort((a, b) => parseInt(b.dataset.value) - parseInt(a.dataset.value));

  let remaining = Math.floor(totalPaid);

  denoms.forEach(input => {
    const value = parseInt(input.dataset.value);
    const count = Math.floor(remaining / value);
    input.value = count;
    remaining -= count * value;
  });
}

function calculateBalance() {
  const total = parseFloat(document.getElementById("total").innerText) || 0;
  const paid = parseFloat(document.getElementById("paid_amount").value) || 0;

  const errorDiv = document.getElementById("paid_error");
  
  if (paid < total) {
    errorDiv.innerText = "Paid amount is less than total bill!";
    errorDiv.style.display = "block";
  } else {
    errorDiv.innerText = "";
    errorDiv.style.display = "none";
  }
}

function calculatePaidAmount() {
  let paid = 0;

  document.querySelectorAll("[data-value]").forEach(input => {
    paid += parseInt(input.dataset.value) * parseInt(input.value || 0);
  });

  document.getElementById("paid_amount").value = paid.toFixed(2);

  calculateBalance();
}

function loadCustomerPurchases() {
  const email = document.getElementById("customer_email").value;
  if (!email) return alert("Enter customer email");

  fetch(`/customer_purchases?email=${encodeURIComponent(email)}`)
    .then(r => r.json())
    .then(purchases => {
      const container = document.getElementById("purchase_history");
      container.innerHTML = "";
      const prevItems = document.getElementById("previous_items");
      prevItems.innerHTML = "";

      if (purchases.length === 0) {
        container.innerHTML = "<p>No previous purchases found.</p>";
        return;
      }

      const table = document.createElement("table");
      table.border = 1;
      table.cellPadding = 4;
      table.style.width = "100%";
      table.innerHTML = `<tr>
        <th>Purchase ID</th><th>Total</th><th>Paid</th><th>Balance</th><th>Date</th><th>Action</th>
      </tr>`;

      purchases.forEach(p => {
        const row = table.insertRow();
        row.innerHTML = `
          <td>${p.id}</td>
          <td>₹${p.total_amount}</td>
          <td>₹${p.paid_amount}</td>
          <td>₹${p.balance_amount}</td>
          <td>${new Date(p.created_at).toLocaleString()}</td>
          <td><button type="button" onclick="showPurchaseItems(${p.id})">View Items</button></td>
        `;
      });

      container.appendChild(table);
    });
}

function showPurchaseItems(purchaseId) {
  fetch(`/purchase_items/${purchaseId}`)
    .then(r => r.json())
    .then(items => {
      let html = '<h4>Items in Purchase</h4>';
      html += '<table border="1" cellpadding="4"><tr><th>Product</th><th>Qty</th><th>Unit Price</th><th>Total</th></tr>';
      items.forEach(item => {
        html += `<tr>
          <td>${item.product.name}</td>
          <td>${item.quantity}</td>
          <td>₹${item.unit_price}</td>
          <td>₹${item.total_price}</td>
        </tr>`;
      });
      html += '</table>';
      document.getElementById("previous_items").innerHTML = html;
    });
}

</script>